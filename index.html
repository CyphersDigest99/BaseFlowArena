<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freestyle Flow Arena</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <!-- Howler.js (must be before beatManager.js/main.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <!-- Wavesurfer.js - Commented out for Howler-only player -->
    <!-- <script src="https://unpkg.com/wavesurfer.js@7.6.0/dist/wavesurfer.min.js"></script> -->
    <!-- jsmediatags -->
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <!-- THREE.JS LIBRARY Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <!-- CANVAS FOR THREE.JS BACKGROUND -->
    <canvas id="bg-canvas"></canvas>

    <header class="game-header">
        <h1>Freestyle Flow Arena</h1>
        <div class="stats-display">
            <div class="stat-item">
                <span class="stat-label">SCORE</span>
                <span id="score" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">STREAK</span>
                <span id="streak-counter" class="stat-value">0</span>
            </div>
        </div>
    </header>

    <main class="game-arena">

        <!-- Left Panel: Word Source & RNG -->
        <aside class="control-panel panel-left">
            <h2><i class="fas fa-cog"></i> Word Settings</h2>
            <div class="control-group">
                <label for="word-order"><i class="fas fa-random"></i> Order:</label>
                <select id="word-order">
                    <option value="random" selected>Random</option>
                    <option value="alphabetical">A-Z</option>
                    <option value="sequential">Sequential</option>
                </select>
            </div>
            
            <div class="syllable-filter-section">
                <div class="syllable-header">
                    <h3><i class="fas fa-sort-numeric-up"></i> Syllables</h3>
                    <button id="reset-syllables-button" class="syllable-reset-button" title="Reset to No Limits">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
                <div class="syllable-controls">
                    <div class="control-group">
                        <label for="min-syllables"><i class="fas fa-sort-numeric-down"></i> Min:</label>
                        <select id="min-syllables" class="syllable-select">
                            <option value="0">∞</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6+</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="max-syllables"><i class="fas fa-sort-numeric-up"></i> Max:</label>
                        <select id="max-syllables" class="syllable-select">
                            <option value="0">∞</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6+</option>
                        </select>
                    </div>
                </div>
            </div>
            
             <div class="control-group">
                 <label><i class="fas fa-list-ul"></i> List:</label>
                 <button id="edit-word-list-button" class="icon-button" title="Edit Word List">
                     <i class="fas fa-edit"></i><span class="btn-text">Edit</span>
                 </button>
                  <button id="favorites-button" class="icon-button" title="View Favorites">
                     <i class="fas fa-star"></i><span class="btn-text">Favs</span>
                  </button>
                 <button id="settings-button" class="icon-button" title="Settings & Data Management">
                     <i class="fas fa-cog"></i><span class="btn-text">Settings</span>
                 </button>
             </div>

             <div class="control-group voice-setting"> <!-- Kept your voice setting toggle here -->
                <label for="voice-rhyme-nav" class="checkbox-label" title="If checked, voice matches will cycle through rhymes instead of changing the base word.">
                     <input type="checkbox" id="voice-rhyme-nav"> Voice Nav Rhymes?
                </label>
             </div>

            <h2><i class="fas fa-dice"></i> Number Gen</h2>
            <div id="rng-controls" class="panel">
                <div class="control-group">
                    <label for="rng-digits"><i class="fas fa-hashtag"></i> Digits:</label>
                    <input type="number" id="rng-digits" min="1" max="7" value="3">
                </div>
                <div class="control-group">
                    <label for="rng-sets"><i class="fas fa-list-ol"></i> Sets:</label>
                    <input type="number" id="rng-sets" min="1" max="5" value="1">
                </div>
                <div class="control-group rng-options">
                    <label for="rng-surprise-me" class="checkbox-label">
                        <input type="checkbox" id="rng-surprise-me"> Surprise Me?
                   </label>
                </div>
                <button id="generate-numbers-button" class="icon-button"><i class="fas fa-dice-d6"></i> Generate</button>
            </div>
            <div id="rng-display-area">
                <!-- Slots generated by JS -->
            </div>
        </aside>

        <!-- Center Stage: Word Display & Activation -->
        <section class="center-stage">
            <div id="feedback-message"></div> <!-- For Hit/Miss/Info messages -->

            <!-- Word Display Area -->
            <div id="word-display-area">
                 <button id="prev-word" class="word-nav-arrow side-arrow left-arrow" title="Previous Word">
                     <i class="fas fa-chevron-left"></i>
                 </button>
                 <button id="up-word" class="word-nav-arrow top-bottom-arrow up-arrow" title="Previous Rhyme">
                     <i class="fas fa-chevron-up"></i>
                 </button>
                 <div id="word-display-container">
                    <div id="word-display">LOADING...</div>
                     <button id="blacklist-word" class="word-action-icon blacklist-icon" title="Blacklist Word">
                         <i class="fas fa-ban"></i>
                     </button>
                     <button id="favorite-word" class="word-action-icon favorite-icon" title="Favorite Word">
                         <i class="far fa-star"></i> <i class="fas fa-star solid-star"></i>
                     </button>
                     <button id="means-like-button" class="word-action-icon means-like-icon" title="Show Synonyms & Definition">
                         <i class="fas fa-book"></i>
                     </button>
                     <div id="word-subtext" class="word-subtext"></div>
                 </div>
                  <button id="down-word" class="word-nav-arrow top-bottom-arrow down-arrow" title="Next Rhyme">
                     <i class="fas fa-chevron-down"></i>
                 </button>
                <button id="next-word" class="word-nav-arrow side-arrow right-arrow" title="Next Word">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <!-- END Word Display Area -->

            <!-- Synonyms Box (above word, below up arrow) -->
            <div id="synonyms-box" class="word-info-box synonyms-box">
                <div id="synonyms-content" class="word-info-content"></div>
            </div>
            <!-- Definition Box (below word, above down arrow) -->
            <div id="definition-box" class="word-info-box definition-box">
                <div id="definition-content" class="word-info-content"></div>
            </div>

            <button id="find-rhymes-button" class="icon-button rhyme-find-trigger" title="Find Rhymes">
                <i class="fas fa-music"></i> Find Rhymes
            </button>

            <!-- Activation Controls -->
            <div class="activation-controls panel">
                <h2><i class="fas fa-power-off"></i> Activation Mode</h2>
                <div class="control-group activation-buttons">
                     <button id="voice-mode-button" class="icon-button large-button activation-button" title="Activate Voice Matching">
                        <span class="light"></span>
                        <i class="fas fa-microphone"></i> Voice Match
                     </button>
                     <button id="timed-mode-button" class="icon-button large-button activation-button" title="Activate Timed Cycle">
                        <i class="fas fa-stopwatch"></i> Timed Cycle
                     </button>
                </div>
                <div id="timed-cycle-options" class="control-group" style="display: none;">
                    <label for="cycle-speed"><i class="fas fa-clock"></i> Speed:</label>
                    <input type="range" id="cycle-speed-slider" min="3" max="30" value="10" step="1" style="flex-grow: 1; margin: 0 10px;">
                    <input type="number" id="cycle-speed" min="3" max="30" value="10" style="width: 55px;">s
                </div>
            </div>
            <!-- END Activation Controls -->

            <!-- Transcript Area -->
            <div class="transcript-area panel">
                 <h2><i class="fas fa-stream"></i> Live Feed</h2>
                 <div id="new-transcript">
                     <!-- Transcript lines generated by JS -->
                 </div>
            </div>
            <!-- END Transcript Area -->
        </section>

        <!-- Right Panel: BPM & Frequencies -->
        <aside class="control-panel panel-right">
            <h2><i class="fas fa-headphones-alt"></i> Rhythm Engine</h2>

            <!-- CORRECTED #bpm-panel Structure -->
                        <!-- CORRECTED #bpm-panel Structure -->
                        <!-- START REPLACEMENT for #bpm-panel section -->
            <div id="bpm-panel" class="panel">
                 <h3><i class="fas fa-tachometer-alt"></i> BPM Control</h3>

                 <!-- Main Controls: TAP, DETECT, and Display Group -->
                 <div class="bpm-main-controls">
                     <button id="bpm-button" class="icon-button large-button" title="Tap for BPM">
                         <i class="fas fa-drum"></i> TAP BPM
                     </button>
                     <button id="detect-bpm-button" class="icon-button large-button" title="Detect BPM from Mic/Audio Input (Approx. 8s)">
                        <i class="fas fa-robot"></i> DETECT
                     </button>
                     <div class="bpm-display-group">
                         <span id="bpm-display">0</span> <span class="bpm-unit">BPM</span>
                     </div>
                 </div>

                 <!-- Adjustment Controls: +/-/Stop -->
                 <div class="bpm-adjust-controls">
                     <button id="bpm-adjust-minus" class="icon-button small-button" title="Decrease BPM"><i class="fas fa-minus"></i></button>
                     <button id="bpm-adjust-plus" class="icon-button small-button" title="Increase BPM"><i class="fas fa-plus"></i></button>
                     <button id="stop-bpm-button" class="icon-button small-button red-button" title="Stop BPM">
                         <i class="fas fa-stop"></i>
                     </button>
                     <button id="save-bpm-button" class="icon-button small-button" title="Save BPM for this track">
                         <i class="fas fa-floppy-disk"></i>
                     </button>
                 </div>

                 <!-- The Grid Container ITSELF -->
                 <div id="four-count-container">
                     <!-- Beat grid generated by JS -->
                 </div>

                 <!-- Grid Size Controls -->
                 <div class="bpm-grid-controls">
                     <label><i class="fas fa-th"></i> Grid:</label>
                     <button id="remove-row-button" class="icon-button tiny-button" title="Remove Row">-</button>
                     <span id="row-count-display">1</span>R
                     <button id="add-row-button" class="icon-button tiny-button" title="Add Row">+</button>
                     <span class="separator">|</span>
                     <button id="remove-col-button" class="icon-button tiny-button" title="Remove Column">-</button>
                     <span id="col-count-display">4</span>C
                     <button id="add-col-button" class="icon-button tiny-button" title="Add Column">+</button>
                 </div>
            </div> <!-- End of #bpm-panel -->
            <!-- END REPLACEMENT for #bpm-panel section -->


            <!-- BPM Multiplier Controls -->
                        <!-- BPM Multiplier Controls -->
            <div class="bpm-multiplier-controls panel">
                <h3><i class="fas fa-forward"></i> Multiplier</h3>
                 <div class="control-group multiplier-buttons">
                     <button class="multiplier-btn" data-multiplier="2">2x</button> <!-- No 'selected' class here initially -->
                     <button class="multiplier-btn" data-multiplier="3">3x</button>
                     <button class="multiplier-btn" data-multiplier="4">4x</button>
                 </div>
            </div>
            <!-- END: BPM Multiplier Controls -->

            <!-- Frequency Panel (Only one needed) -->
            <div id="frequency-panel" class="panel">
                <h2><i class="fas fa-chart-bar"></i> Word Radar</h2>
                <div id="frequent-words">
                    <!-- Frequent words list generated by JS -->
                </div>
            </div>
        </aside>

    </main>

    <!-- Modals -->
    <div id="favorites-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-favorites-modal">×</span>
            <h2><i class="fas fa-star"></i> Favorited Words</h2>
            <ul id="favorites-list"></ul>
            <button id="clear-favorites-button" class="icon-button red-button"><i class="fas fa-trash"></i> Clear All Favorites</button>
        </div>
    </div>

    <div id="word-list-editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-word-list-editor">×</span>
            <h2><i class="fas fa-edit"></i> Edit Word List</h2>
            <div class="word-list-controls">
                <button id="add-word-button" class="icon-button tiny-button" title="Add New Word">
                    <i class="fas fa-plus"></i> Add Word
                </button>
                <button id="reset-word-list-button" class="icon-button tiny-button red-button" title="Reset to Defaults">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button id="export-word-list-button" class="icon-button tiny-button" title="Export Word List">
                    <i class="fas fa-download"></i> Export
                </button>
                <button id="import-word-list-button" class="icon-button tiny-button" title="Import Word List">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
            <textarea id="word-list-textarea" rows="15" cols="50" placeholder="Enter words, one per line..."></textarea>
            <div class="word-list-actions">
                <button id="save-word-list-button" class="icon-button"><i class="fas fa-save"></i> Save Changes</button>
                <p><small>Changes are saved permanently and persist between sessions.</small></p>
            </div>
        </div>
    </div>

    <!-- Rhyme Finder Modal (Using updated header structure) -->
    <div id="rhyme-finder-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-rhyme-modal">×</span>
            <h2><i class="fas fa-music"></i> Rhyme Finder</h2>
            <div class="rhyme-modal-header">
                <div id="rhyme-modal-base-word" class="rhyme-modal-word-display"></div>
                <div id="rhyme-modal-pattern-container" class="rhyme-modal-pattern-display"></div>
                <div class="rhyme-legend">
                    <span class="rhyme-freq-high">High Usage</span> |
                    <span class="rhyme-freq-med">Medium Usage</span> |
                    <span class="rhyme-freq-low">Low Usage</span> |
                    <span class="rhyme-freq-none">Not Used</span>
                </div>
            </div>
            <ul id="rhyme-results-list"></ul>
            <p id="rhyme-no-results" style="display: none;">No other words found with this pattern (or they were rejected).</p>
            <div class="add-rhyme-section">
                <input type="text" id="manual-rhyme-input" placeholder="Add your own rhyme...">
                <button id="add-manual-rhyme-button" class="icon-button tiny-button"><i class="fas fa-plus"></i> Add</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-settings-modal">×</span>
            <h2><i class="fas fa-cog"></i> Settings & Data Management</h2>
            
            <div class="settings-section">
                <h3><i class="fas fa-download"></i> Export & Import</h3>
                <div class="settings-controls">
                    <button id="export-all-settings-button" class="icon-button">
                        <i class="fas fa-download"></i> Export All Settings
                    </button>
                    <button id="import-all-settings-button" class="icon-button">
                        <i class="fas fa-upload"></i> Import All Settings
                    </button>
                </div>
                <p><small>Export/import all your data including word lists, favorites, blacklist, and settings.</small></p>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-trash"></i> Data Management</h3>
                <div class="settings-controls">
                    <button id="clear-blacklist-button" class="icon-button red-button">
                        <i class="fas fa-ban"></i> Clear Blacklist
                    </button>
                    <button id="clear-favorites-button" class="icon-button red-button">
                        <i class="fas fa-star"></i> Clear Favorites
                    </button>
                    <button id="clear-word-frequencies-button" class="icon-button red-button">
                        <i class="fas fa-chart-bar"></i> Clear Word Frequencies
                    </button>
                    <button id="reset-all-settings-button" class="icon-button red-button">
                        <i class="fas fa-undo"></i> Reset All Settings
                    </button>
                </div>
                <p><small>Clear specific data or reset everything to defaults.</small></p>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-info-circle"></i> Data Summary</h3>
                <div id="data-summary">
                    <p>Loading data summary...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Web Audio API version (no specific aubio.js needed for this approach) -->
    <!-- Script tag for aubio.js is NOT needed with the pure Web Audio API detection method -->

    <!-- Main Game Script (MODULE) -->
    <script type="module" src="js/main.js" defer></script>

    <!-- Add compact Beat Player bar at the bottom -->
    <div id="beat-player-bar">
        <img id="album-art" width="50" height="50" style="object-fit:cover;border-radius:6px;margin:0 10px;" alt="Album Art" />
        <div class="beat-player-controls">
            <button id="beat-play-pause" class="icon-button"><i class="fas fa-play"></i></button>
            <button id="beat-prev" class="icon-button"><i class="fas fa-backward"></i></button>
            <button id="beat-next" class="icon-button"><i class="fas fa-forward"></i></button>
        </div>
        <div id="current-beat-display" style="margin:0 10px;min-width:180px;"></div>
        <div id="beat-bpm" style="margin:0 10px;min-width:60px;"></div>
                        <!-- Waveform container hidden for Howler-only player -->
                <div id="waveform" style="display:none;flex:1 1 0%;height:40px;min-width:120px;margin:0 10px;"></div>
        <input id="beat-volume" type="range" min="0" max="100" value="70" style="width:120px;margin:0 10px;" />
    </div>

    <!-- Add CSS for fixed bottom bar -->
    <style>
    #beat-player-bar {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        width: 100vw;
        height: 60px;
        background: #181c2b;
        display: flex;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 -2px 12px #000a;
        border-top: 1px solid #222;
        padding: 0 10px;
    }
    #beat-player-bar .icon-button { margin: 0 2px; }
    #album-art { background: #222; }
    #current-beat-display, #beat-bpm { color: #fff; font-size: 1em; }
    #waveform { background: transparent; }
    </style>
</body>
</html>